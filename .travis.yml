version: ~> 1.0 # Opt in to beta Build Config Validation https://docs.travis-ci.com/user/build-config-validation#beta-opt-in
language: bash # "Setting the language key to bash, sh or shell is equivalent to language: minimal." (https://docs.travis-ci.com/user/languages/minimal-and-generic/#aliases)

services:
    - docker

env:
  - CONTAINER_NAME="Build-$TRAVIS_BUILD_NUMBER"

before_script:
- docker pull seriema/retro-cloud:latest-amd64
- |
    docker container create \
        --cap-add SYS_ADMIN \
        --device /dev/fuse \
        --interactive \
        --rm \
        --tty \
        --name "$CONTAINER_NAME" \
        seriema/retro-cloud:latest-amd64
- docker container start "$CONTAINER_NAME"

script:
# Whereami?
- docker exec "$CONTAINER_NAME" ls -la
# Setup
- docker exec "$CONTAINER_NAME" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${TRAVIS_COMMIT}/raspberry-pi/download-and-run.sh"
- docker exec "$CONTAINER_NAME" bash download-and-run.sh "$TRAVIS_COMMIT"
- docker exec "$CONTAINER_NAME" rm download-and-run.sh
# Teardown
- docker exec "$CONTAINER_NAME" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${TRAVIS_COMMIT}/raspberry-pi/teardown.sh"
- docker exec "$CONTAINER_NAME" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${TRAVIS_COMMIT}/raspberry-pi/teardown-az.ps1"
- docker exec "$CONTAINER_NAME" bash -i teardown.sh
- docker exec "$CONTAINER_NAME" rm teardown.sh
- docker exec "$CONTAINER_NAME" rm teardown-az.ps1

after_script:
- docker stop "$CONTAINER_NAME"
