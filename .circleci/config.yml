version: 2
jobs:
  bashValidation:
    docker:
    - image: koalaman/shellcheck-alpine:stable
    steps:

    - checkout

    - run:
        name: Validate scripts execution permission
        command: |
            findFilesWithoutExecutionPermission () { find . -type f -name '*.sh' -not -executable; }
            if [ $(findFilesWithoutExecutionPermission | wc -l) -ne 0 ]; then
                echo 'These files are lacking execute (+x) permission:'
                findFilesWithoutExecutionPermission
                exit 1;
            fi

    - run:
        name: Lint Scripts
        command: find . -type f -name '*.sh' | xargs shellcheck --external-sources

  scriptValidation:
    machine:
      image: ubuntu-1604:201903-01
    steps:

    - run:
        name: Get the latest Docker image
        command: docker pull seriema/retro-cloud:latest-amd64

    - run:
        name: Create Docker container to emulate a RaspberryPi with RetroPie
        command: |
            docker container create \
                --cap-add SYS_ADMIN \
                --device /dev/fuse \
                --interactive \
                --rm \
                --tty \
                --name "Build-$CIRCLE_BUILD_NUM" \
                seriema/retro-cloud:latest-amd64

    - run:
        name: Start the container
        command: docker container start "Build-$CIRCLE_BUILD_NUM"

    - run:
        name: Install Retro-Cloud on RaspberryPi (Setup Azure resources)
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/raspberry-pi/download-and-run.sh"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash download-and-run.sh $CIRCLE_SHA1
            docker exec "Build-$CIRCLE_BUILD_NUM" rm download-and-run.sh

    - run:
        name: Install Retro-Cloud on VM
        command: docker exec "Build-$CIRCLE_BUILD_NUM" bash -i setup-vm.sh $CIRCLE_SHA1

    - run:
        name: Copy a freeware ROM to VM
        command: docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "curl -L https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/virtual-machine/dev/test-copy-rom.sh | bash -i"

    - run:
        name: Add Screenscraper.fr credentials to VM
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "echo '' | tee -a ~/.skyscraper/config.ini"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "echo '[screenscraper]' | tee -a ~/.skyscraper/config.ini"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "echo 'userCreds=\"${SCREENSCRAPER_USER}:${SCREENSCRAPER_KEY}\"' | tee -a ~/.skyscraper/config.ini"

    - run:
        name: Run scraper on VM
        command: docker exec "Build-$CIRCLE_BUILD_NUM" bash -i run-scraper.sh

    - run:
        name: Verify that ROM shows up in Azure File Share
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/raspberry-pi/dev/test-az-share.ps1"
            docker exec "Build-$CIRCLE_BUILD_NUM" echo 'pwsh -executionpolicy bypass -File ".\test-az-share.ps1"' > run-az-share-test.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i run-az-share-test.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" rm run-az-share-test.sh test-az-share.ps1

    - run:
        name: Verify scraper output on VM
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "mkdir -p ~/tmp"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "curl -L -o ~/tmp/test-gamelist.sh https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/virtual-machine/dev/test-gamelist.sh"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "curl -L -o ~/tmp/test-gamelist.xml https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/virtual-machine/dev/test-gamelist.xml"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "curl -L -o ~/tmp/test-gamelist-screenscraper-failed.xml https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/virtual-machine/dev/test-gamelist-screenscraper-failed.xml"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "bash -i ~/tmp/test-gamelist.sh"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "rm ~/tmp/test-gamelist.sh ~/tmp/test-gamelist.xml ~/tmp/test-gamelist-screenscraper-failed.xml"

    - run:
        name: Print RaspberryPi ~/.retro-cloud.env
        command: docker exec "Build-$CIRCLE_BUILD_NUM" cat ~/.retro-cloud.env
        when: always

    - run:
        name: Print VM ~/.retro-cloud.env
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" echo 'ssh $RETROCLOUD_VM_USER@$RETROCLOUD_VM_IP "cat ~/.retro-cloud.env"' > print-vm-bashrc.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i print-vm-bashrc.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" rm print-vm-bashrc.sh
        when: always

    - run:
        name: Print RaspberryPi ~/.bashrc
        command: cat ~/.bashrc
        when: always

    - run:
        name: Print VM ~/.bashrc
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" echo 'ssh $RETROCLOUD_VM_USER@$RETROCLOUD_VM_IP "cat ~/.bashrc"' > print-vm-bashrc.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i print-vm-bashrc.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" rm print-vm-bashrc.sh
        when: always

    - run:
        name: Print RaspberryPi ~/ directory listing
        command: docker exec "Build-$CIRCLE_BUILD_NUM" sudo find ~ | sed -e "s/[^-][^\/]*\// |/g" -e "s/|\([^ ]\)/|-\1/"
        when: always

    - run:
        name: Print VM ~/ directory listing
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" printCmd='sudo find ~ | sed -e "s/[^-][^\/]*\// |/g" -e "s/|\([^ ]\)/|-\1/"'
            docker exec "Build-$CIRCLE_BUILD_NUM" echo 'ssh $RETROCLOUD_VM_USER@$RETROCLOUD_VM_IP' "'$printCmd'" > print-vm-filesystem.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i print-vm-filesystem.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" rm print-vm-filesystem.sh
        when: always

    - run:
        name: Print Azure File Share directory listing
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/raspberry-pi/dev/list-az-share.ps1"
            docker exec "Build-$CIRCLE_BUILD_NUM" echo 'pwsh -executionpolicy bypass -File ".\list-az-share.ps1"' > run-az-listing.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i run-az-listing.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" rm run-az-listing.sh list-az-share.ps1
        when: always

    - run:
        name: Print VM Skyscraper config
        command: docker exec "Build-$CIRCLE_BUILD_NUM" bash -i ssh-vm.sh "cat ~/.skyscraper/config.ini"
        when: always

    - run:
        name: Teardown Azure resources
        command: |
            docker exec "Build-$CIRCLE_BUILD_NUM" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/raspberry-pi/teardown.sh"
            docker exec "Build-$CIRCLE_BUILD_NUM" curl -OL "https://raw.githubusercontent.com/seriema/retro-cloud/${CIRCLE_SHA1}/raspberry-pi/teardown-az.ps1"
            docker exec "Build-$CIRCLE_BUILD_NUM" bash -i teardown.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" rm teardown.sh
            docker exec "Build-$CIRCLE_BUILD_NUM" rm teardown-az.ps1
        when: always

    - run:
        name: Stop and remove Docker container
        command: docker stop "Build-$CIRCLE_BUILD_NUM"
        when: always

  imageValidation:
    docker:
    - image: seriema/retro-cloud:develop
    working_directory: /home/pi/retro-cloud
    steps:

    - checkout

    - run:
        name: Validate Docker image
        command: bash docker/compose/run_tests.sh

workflows:
  version: 2
  commit:
    jobs:
    - bashValidation
    - scriptValidation
    - imageValidation
